name: GitHub Classroom Workflow

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  autograding:
    name: Autograding
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc make libc6-dev

      - name: Compilation Test (20 points)
        id: compilation
        run: |
          make clean
          if make all 2>&1; then
            echo "score=20" >> $GITHUB_OUTPUT
            echo "âœ… Compilation successful (20/20 points)"
          else
            echo "score=0" >> $GITHUB_OUTPUT
            echo "âŒ Compilation failed (0/20 points)"
            exit 1
          fi

      - name: Voltage Validation Tests (40 points)
        id: voltage-tests
        run: |
          ./tests/test_voltage > voltage_results.txt 2>&1 || true
          cat voltage_results.txt

          passed=$(grep "Passed:" voltage_results.txt | awk '{print $2}' || echo "0")
          total=$(grep "Total tests:" voltage_results.txt | awk '{print $3}' || echo "10")

          if [ "$total" -eq 0 ]; then
            score=0
          else
            score=$((passed * 40 / total))
          fi

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "passed=$passed" >> $GITHUB_OUTPUT
          echo "total=$total" >> $GITHUB_OUTPUT
          echo "âœ… Voltage tests: $passed/$total passed ($score/40 points)"

      - name: Power Calculation Tests (40 points)
        id: power-tests
        run: |
          ./tests/test_power > power_results.txt 2>&1 || true
          cat power_results.txt

          passed=$(grep "Passed:" power_results.txt | awk '{print $2}' || echo "0")
          total=$(grep "Total tests:" power_results.txt | awk '{print $3}' || echo "10")

          if [ "$total" -eq 0 ]; then
            score=0
          else
            score=$((passed * 40 / total))
          fi

          echo "score=$score" >> $GITHUB_OUTPUT
          echo "passed=$passed" >> $GITHUB_OUTPUT
          echo "total=$total" >> $GITHUB_OUTPUT
          echo "âœ… Power tests: $passed/$total passed ($score/40 points)"

      - name: Calculate Final Score
        run: |
          compilation_score=${{ steps.compilation.outputs.score }}
          voltage_score=${{ steps.voltage-tests.outputs.score }}
          power_score=${{ steps.power-tests.outputs.score }}

          total_score=$((compilation_score + voltage_score + power_score))

          echo "## í ½í³Š Autograding Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Category | Score | Max Points |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|-------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Compilation | $compilation_score | 20 |" >> $GITHUB_STEP_SUMMARY
          echo "| Voltage Tests | $voltage_score | 40 |" >> $GITHUB_STEP_SUMMARY
          echo "| Power Tests | $power_score | 40 |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$total_score** | **100** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$total_score" -ge 90 ]; then
            echo "í ¼í¾‰ **Excellent work!** Grade: A" >> $GITHUB_STEP_SUMMARY
          elif [ "$total_score" -ge 80 ]; then
            echo "í ½í± **Good work!** Grade: B" >> $GITHUB_STEP_SUMMARY
          elif [ "$total_score" -ge 70 ]; then
            echo "í ½í³š **Needs improvement** Grade: C" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Significant issues** Grade: F" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### í ½í³ Detailed Results:" >> $GITHUB_STEP_SUMMARY
          echo "- Voltage validation tests: ${{ steps.voltage-tests.outputs.passed }}/${{ steps.voltage-tests.outputs.total }} passed" >> $GITHUB_STEP_SUMMARY
          echo "- Power calculation tests: ${{ steps.power-tests.outputs.passed }}/${{ steps.power-tests.outputs.total }} passed" >> $GITHUB_STEP_SUMMARY

      - name: Autograding Reporter
        uses: education/autograding-command@v1
        with:
          test-name: 'Compilation Check'
          setup-command: 'make clean'
          command: 'make all'
          timeout: 10
          max-score: 20

      - name: Voltage Tests Reporter
        uses: education/autograding-command@v1
        with:
          test-name: 'Voltage Validation Tests'
          setup-command: ''
          command: './tests/test_voltage'
          timeout: 10
          max-score: 40

      - name: Power Tests Reporter
        uses: education/autograding-command@v1
        with:
          test-name: 'Power Calculation Tests'
          setup-command: ''
          command: './tests/test_power'
          timeout: 10
          max-score: 40

